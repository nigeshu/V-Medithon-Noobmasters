<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal | V‚ÄëMedithon</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/styles.css">
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
    <style>
      .portal-wrap { max-width: 840px; margin: 0 auto; }
      .role-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-top: 18px; }
      .role { background:#ffffff; border:1px solid var(--border); border-radius: 14px; padding: 18px; text-align:center; box-shadow: 0 8px 20px rgba(2,6,23,0.06); cursor: pointer; }
      .role h3 { margin: 8px 0 6px; }
      .role p { color:#475569; margin:0; font-size:14px; }
      .active { outline: 2px solid var(--primary); }
      .login-card { background:#ffffff; border:1px solid var(--border); border-radius:14px; padding:18px; margin-top:16px; box-shadow: 0 8px 20px rgba(2,6,23,0.06); }
      .input { width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; }
      .input:focus { outline:none; border-color: var(--primary); box-shadow: 0 8px 20px rgba(37,99,235,0.15); }
      .hint { color:#64748b; font-size:12px; margin-top:6px; }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="container nav">
            <a class="logo" href="index.html">V‚ÄëMedithon</a>
            <nav class="main-nav">
                <a href="ai.html" class="btn btn-outline">AI Chatbot</a>
                <a href="community.html" class="btn btn-secondary">Join Community</a>
            </nav>
        </div>
    </header>

    <main>
        <section class="section">
            <div class="container portal-wrap">
                <h1 class="section-title">Enter Portal</h1>
                <p class="section-lead">Choose your role and enter your ID to continue. We use the ID to personalize your experience and track events.</p>
                <div class="role-grid" id="roles">
                    <div class="role" data-role="doctor">
                        <div style="font-size:28px;">ü©∫</div>
                        <h3>Doctor</h3>
                        <p>Clinical insights, guidelines, and case collaboration.</p>
                    </div>
                    <div class="role" data-role="admin">
                        <div style="font-size:28px;">üõ†Ô∏è</div>
                        <h3>Admin</h3>
                        <p>Manage doctors, patients, and solution mappings.</p>
                    </div>
                    <div class="role" data-role="patient">
                        <div style="font-size:28px;">üßë‚Äçü¶Ω</div>
                        <h3>Patient</h3>
                        <p>Personalized education and symptom tracking.</p>
                    </div>
                </div>

                <div class="login-card">
                    <h3 id="login-title">Login / Signup</h3>
                    <div style="display:grid; gap:10px; margin-top:8px;">
                        <input id="email" class="input" placeholder="Email" type="email" />
                        <input id="password" class="input" placeholder="Password" type="password" />
                        <div style="display:flex; gap:10px;">
                          <button id="signup" class="btn btn-secondary" style="flex:1;">Sign up</button>
                          <button id="signin" class="btn btn-primary" style="flex:1;">Sign in</button>
                        </div>
                        <div class="hint" id="role-hint">Select a role above. Accounts are linked with a role in Firestore.</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
    import { firebaseConfig } from './chatbot/firebase-config.js';
    
    // Init Firebase
    // eslint-disable-next-line no-undef
    const app = firebase.initializeApp(firebaseConfig);
    // eslint-disable-next-line no-undef
    const auth = firebase.auth();
    // eslint-disable-next-line no-undef
    const db = firebase.firestore();
    const roles = document.getElementById('roles');
    const loginTitle = document.getElementById('login-title');
    const roleHint = document.getElementById('role-hint');
    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const signinBtn = document.getElementById('signin');
    const signupBtn = document.getElementById('signup');
    let selected = null;

    roles.addEventListener('click', (e)=>{
      const card = e.target.closest('.role');
      if (!card) return;
      roles.querySelectorAll('.role').forEach(r => r.classList.remove('active'));
      card.classList.add('active');
      selected = card.dataset.role;
      const friendly = selected.charAt(0).toUpperCase() + selected.slice(1);
      loginTitle.textContent = `Login as ${friendly}`;
      roleHint.textContent = `${friendly} portal selected. Enter your ID to continue.`;
    });

    async function ensureUserDoc(uid, email){
      const ref = db.collection('users').doc(uid);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({ email, role: selected || 'patient', createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      } else if (selected) {
        await ref.update({ role: selected, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      }
    }

    signinBtn.addEventListener('click', async ()=>{
      if (!selected) { alert('Please select a role.'); return; }
      const email = (emailEl.value||'').trim();
      const password = (passEl.value||'').trim();
      if (!email || !password) { alert('Enter email and password.'); return; }
      try {
        const res = await auth.signInWithEmailAndPassword(email, password);
        await ensureUserDoc(res.user.uid, email);
        localStorage.setItem('v_user_role', selected);
        // Redirect by role
        location.href = selected === 'doctor' ? 'doctor.html' : selected === 'admin' ? 'admin.html' : 'patient.html';
      } catch (e) {
        alert(e.message);
      }
    });

    signupBtn.addEventListener('click', async ()=>{
      if (!selected) { alert('Please select a role.'); return; }
      const email = (emailEl.value||'').trim();
      const password = (passEl.value||'').trim();
      if (!email || !password) { alert('Enter email and password.'); return; }
      try {
        const res = await auth.createUserWithEmailAndPassword(email, password);
        await ensureUserDoc(res.user.uid, email);
        localStorage.setItem('v_user_role', selected);
        location.href = selected === 'doctor' ? 'doctor.html' : selected === 'admin' ? 'admin.html' : 'patient.html';
      } catch (e) {
        alert(e.message);
      }
    });
    </script>
</body>
</html>


